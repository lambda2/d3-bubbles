<html>

<head>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>

<style>
  #top-bar
  {
    position: absolute;
    top: 0px;
    bottom: 0px;
    min-width: 300px;
    min-height: 500px;
  }
</style>
</head>

<body>

  <script>

  var data_one = {
    'children': [
      {
        "name": "name1",
        "length": 120,
        "progress": 20
      },
      {
        "name": "name2",
        "length": 50,
        "progress": 12
      },
      {
        "name": "name3",
        "length": 30,
        "progress": 86
      },
      {
        "name": "name4",
        "length": 450,
        "progress": 53
      },
      {
        "name": "name5",
        "length": 130,
        "progress": 5
      }
    ]
  };



  var data_two = {
    'children': [
      {
        "name": "name1",
        "length": 60,
        "progress": 20
      },
      {
        "name": "name2",
        "length": 150,
        "progress": 40
      },
      {
        "name": "name3",
        "length": 86,
        "progress": 86
      },
      {
        "name": "name4",
        "length": 12,
        "progress": 99
      },
      {
        "name": "name5",
        "length": 20,
        "progress": 75
      },
      {
        "name": "name6",
        "length": 335,
        "progress": 90
      },
      {
        "name": "name7",
        "length": 60,
        "progress": 50
      }
    ]
  };

  var diameter = 960,
  format = d3.format(",d"),
  color = d3.scale.category20c();


  var svg = d3.select("body").append("svg")
  .attr("width", diameter)
  .attr("height", diameter)
  .attr("class", "bubble");
      var bubble = d3.layout.pack()
      .sort(null)
      .size([diameter, diameter])
      .padding(1.5);

  function inspect(e) { console.warn("Inspection: ", e); return e;}

  function loadData(root)
  {

    var node = svg.selectAll(".node")
    .data(bubble.nodes(classes(root))
    .filter(function(d) {
      console.log("[filter] => ", d);
      return !d.children; }), function(d){ return d.className; })
    .enter().append("g")
    .attr("class", "node")
    .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

    node.append("title")
    .text(function(d) { return d.className + ": " + format(d.value); });

    node.append("circle")
      .attr("r", 0)
      .style("fill", function(d) {
        console.log(d);
        return d3.rgb(150, 150, 150);
      }).transition()
    .attr("r", function(d) { return d.r; })
    .style("fill", function(d) {
      console.log(d);
      return d3.rgb((d.red * 255) / 100, (d.green * 255) / 100, 50);
    });

    node.append("text")
    .attr("dy", ".3em")
    .style("text-anchor", "middle")
    .text(function(d) { return d.className.substring(0, d.r / 3); });

    node.on("hover", function(a, b,c )
    {
      a.transition().style("fill", function(d) {
        console.log(d);
        return d3.rgb(150, 150, 150);
      });
    });
    node.on("click", function(a, b,c )
    {
      console.log("click", a, b, c);
      var elt = document.getElementById("data-content");
      elt.innerHTML = "<p>Name: " + a.className + "</p><p>Progression: " + a.progress + "%</p><p>Length :" + a.value + "</p>"
    });

    // Returns a flattened hierarchy containing all leaf nodes under the root.
    function classes(root) {
      var classes = [];

      function recurse(name, node) {
        console.log("Calling recurse on ", name, node);
        if (node.children) node.children.forEach(function(child) { recurse(node.name, child); });
        else classes.push({
          packageName: node.name,
          className: node.name,
          value: node.length,
          progress: node.progress,
          green: node.progress,
          red: 100 - node.progress
        });
      }

      recurse(null, root);
      return {children: classes};
    }

    d3.select(self.frameElement).style("height", diameter + "px");
  }
  loadData(data_one);
  </script>

  <div id="top-bar">
    <div id="data-content">

    </div>
      <div id="buttons">
        <button id="data_one" onClick="loadData(data_one)">Set 1</button>
        <button id="data_two" onClick="loadData(data_two)">Set 2</button>
      </div>
  </div>

</body>



</html>
